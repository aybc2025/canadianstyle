<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Canadian Style - Interactive Learning Platform</title>
    <meta name="description" content="Master Canadian writing conventions with interactive lessons based on The Canadian Style guide.">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="shared/img/maple-logo.svg">
    
    <!-- CSS -->
    <link rel="stylesheet" href="shared/css/main.css">
    
    <!-- Preload critical resources -->
    <link rel="modulepreload" href="shared/js/progress.js">
    <link rel="modulepreload" href="shared/js/components.js">
</head>
<body class="dashboard-page">
    <!-- Header -->
    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <img src="shared/img/maple-logo.svg" alt="Canadian Style Logo" class="logo" width="32" height="32">
                    <div class="logo-text">
                        <h1>The Canadian Style</h1>
                        <p>Interactive Learning Platform</p>
                    </div>
                </div>
                
                <nav class="main-nav">
                    <ul>
                        <li><a href="#" class="nav-link active">Dashboard</a></li>
                        <li><a href="#about" class="nav-link">About</a></li>
                        <li><a href="#help" class="nav-link">Help</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Welcome Section -->
            <section class="welcome-section">
                <h2>Master Canadian Writing Conventions</h2>
                <p>Learn the essential rules and guidelines from <em>The Canadian Style</em> (1997 revised edition) through interactive lessons, quizzes, and practical exercises.</p>
                
                <!-- Overall Progress -->
                <div class="progress-overview">
                    <div class="progress-stat">
                        <span class="stat-number" id="overallCompletion">0%</span>
                        <span class="stat-label">Overall Progress</span>
                    </div>
                    <div class="progress-stat">
                        <span class="stat-number" id="completedChapters">0</span>
                        <span class="stat-label">Chapters Completed</span>
                    </div>
                    <div class="progress-stat">
                        <span class="stat-number">16</span>
                        <span class="stat-label">Total Chapters</span>
                    </div>
                </div>
            </section>

            <!-- Filter Section -->
            <section class="filter-section">
                <h3>Browse by Category</h3>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">
                        All Subjects
                        <span class="filter-count">16 chapters</span>
                    </button>
                    <button class="filter-btn" data-filter="typography">
                        Typography & Format
                        <span class="filter-count">11 chapters</span>
                    </button>
                    <button class="filter-btn" data-filter="style">
                        Style & Usage
                        <span class="filter-count">5 chapters</span>
                    </button>
                </div>
            </section>

            <!-- Chapters Grid -->
            <section class="chapters-section">
                <div class="chapters-grid" id="chaptersGrid">
                    <!-- Chapter cards will be rendered here by JavaScript -->
                    <div class="loading-message">
                        <p>Loading chapters...</p>
                    </div>
                </div>
            </section>

            <!-- Quick Start Section -->
            <section class="quick-start-section">
                <h3>Quick Start Guide</h3>
                <div class="guide-cards">
                    <div class="guide-card">
                        <div class="guide-icon">ðŸ“š</div>
                        <h4>Start Learning</h4>
                        <p>Choose any chapter that interests you. Each chapter is self-contained with clear explanations and examples.</p>
                    </div>
                    <div class="guide-card">
                        <div class="guide-icon">âœ“</div>
                        <h4>Track Progress</h4>
                        <p>Complete sections and quizzes to track your progress. Your achievements are automatically saved.</p>
                    </div>
                    <div class="guide-card">
                        <div class="guide-icon">ðŸŽ¯</div>
                        <h4>Test Knowledge</h4>
                        <p>Interactive quizzes and exercises help reinforce what you've learned in each section.</p>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer class="main-footer">
        <div class="container">
            <p>&copy; 2024 The Canadian Style Interactive Learning Platform. 
            Based on "The Canadian Style" (1997 revised edition).</p>
        </div>
    </footer>

    <!-- Include JavaScript modules -->
    <script type="module" src="shared/js/progress.js"></script>
    <script type="module" src="shared/js/components.js"></script>
    <script type="module">
        import { getProgress, setProgress, getChapterProgress, calculateChapterProgress } from './shared/js/progress.js';
        
        // Wait for all modules to load completely
        function waitForModules() {
            return new Promise((resolve) => {
                const maxAttempts = 100; // 1 second timeout
                let attempts = 0;
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    
                    // Check if all required functions are available
                    if (window.calculateChapterProgress && 
                        window.getChapterProgress && 
                        window.progressModuleLoaded &&
                        typeof calculateChapterProgress === 'function') {
                        
                        clearInterval(checkInterval);
                        console.log('All modules loaded successfully');
                        resolve();
                        return;
                    }
                    
                    // Timeout after max attempts
                    if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        console.warn('Module loading timeout - continuing with fallbacks');
                        resolve();
                    }
                }, 10);
            });
        }
        
        // Make progress functions globally available with error handling
        function setupGlobalFunctions() {
            try {
                window.getProgress = getProgress;
                window.setProgress = setProgress;
                window.getChapterProgress = getChapterProgress;
                window.calculateChapterProgress = calculateChapterProgress;
                console.log('Global progress functions set up successfully');
            } catch (error) {
                console.error('Error setting up global functions:', error);
            }
        }
        
        // Chapter data - matches the structure in project files
        const chaptersData = [
            { id: 'ch01', number: '01', title: 'Capitalization', description: 'Rules for using capital letters correctly.', sections: 8, category: 'typography' },
            { id: 'ch02', number: '02', title: 'Hyphenation', description: 'Compounding and word division rules.', sections: 6, category: 'typography' },
            { id: 'ch03', number: '03', title: 'Spelling', description: 'Canadian spelling conventions and preferences.', sections: 5, category: 'typography' },
            { id: 'ch04', number: '04', title: 'Abbreviations', description: 'When and how to use abbreviations properly.', sections: 7, category: 'typography' },
            { id: 'ch05', number: '05', title: 'Numbers', description: 'Rules for writing numerical expressions.', sections: 9, category: 'typography' },
            { id: 'ch06', number: '06', title: 'Italics', description: 'When to use italic type for emphasis.', sections: 4, category: 'typography' },
            { id: 'ch07', number: '07', title: 'Punctuation', description: 'Complete guide to punctuation marks.', sections: 8, category: 'typography' },
            { id: 'ch08', number: '08', title: 'Quotations', description: 'Quotation marks and citing sources.', sections: 6, category: 'typography' },
            { id: 'ch09', number: '09', title: 'Reference Matter', description: 'Bibliographies, footnotes, and citations.', sections: 5, category: 'typography' },
            { id: 'ch10', number: '10', title: 'Letters', description: 'Business correspondence formatting.', sections: 6, category: 'typography' },
            { id: 'ch11', number: '11', title: 'Reports', description: 'Reports and minutes structure.', sections: 7, category: 'typography' },
            { id: 'ch12', number: '12', title: 'Usage', description: 'Common usage issues and solutions.', sections: 3, category: 'style' },
            { id: 'ch13', number: '13', title: 'Plain Language', description: 'Writing clearly and simply.', sections: 7, category: 'style' },
            { id: 'ch14', number: '14', title: 'Bias-Free Writing', description: 'Elimination of stereotyping in writing.', sections: 4, category: 'style' },
            { id: 'ch15', number: '15', title: 'Geographical Names', description: 'Canadian geographical naming conventions.', sections: 5, category: 'style' },
            { id: 'ch16', number: '16', title: 'Revision', description: 'Revision and proofreading techniques.', sections: 7, category: 'style' }
        ];

        // Initialize dashboard with proper error handling
        async function initializeDashboard() {
            try {
                console.log('Initializing dashboard...');
                
                // Wait for all modules to load
                await waitForModules();
                
                // Set up global functions
                setupGlobalFunctions();
                
                // Now safely render the components
                renderChapterCards();
                updateOverallProgress();
                setupFilterButtons();
                
                console.log('Dashboard initialized successfully');
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                
                // Show error message to user
                showErrorMessage('Unable to load dashboard completely. Some features may not work properly.');
                
                // Try to render with fallbacks
                renderChapterCardsWithFallback();
            }
        }

        // Render chapter cards with full error handling
        function renderChapterCards() {
            try {
                const grid = document.getElementById('chaptersGrid');
                if (!grid) {
                    console.error('Chapters grid not found');
                    return;
                }
                
                grid.innerHTML = '';

                chaptersData.forEach(chapter => {
                    try {
                        // Safe calculation of completion with multiple fallbacks
                        let completion = 0;
                        
                        if (typeof window.calculateChapterProgress === 'function') {
                            completion = window.calculateChapterProgress(chapter.id) || 0;
                        } else if (typeof calculateChapterProgress === 'function') {
                            completion = calculateChapterProgress(chapter.id) || 0;
                        }
                        
                        // Ensure completion is a valid number
                        completion = Math.max(0, Math.min(100, Number(completion) || 0));
                        
                        const ctaText = completion > 0 ? 'Continue' : 'Start';
                        
                        // Create card element
                        const card = document.createElement('div');
                        card.className = 'chapter-card';
                        card.setAttribute('data-category', chapter.category);
                        card.innerHTML = `
                            <div class="card-header">
                                <span class="chapter-number">${chapter.number}</span>
                                <div class="progress-container">
                                    <div class="progress-ring" data-percentage="${completion}">
                                        <svg width="60" height="60" viewBox="0 0 60 60">
                                            <circle cx="30" cy="30" r="25" stroke="#e5e5e5" stroke-width="6" fill="none"/>
                                            <circle cx="30" cy="30" r="25" stroke="#d71920" stroke-width="6" fill="none"
                                                    stroke-dasharray="${157 * (completion / 100)} 157"
                                                    stroke-linecap="round" transform="rotate(-90 30 30)"/>
                                            <text x="30" y="35" text-anchor="middle" font-size="12" font-weight="bold" fill="#d71920">
                                                ${completion}%
                                            </text>
                                        </svg>
                                    </div>
                                    <div class="completion-badge ${completion === 100 ? 'completed' : ''}" ${completion === 100 ? 'style="display: block;"' : ''}>âœ“</div>
                                </div>
                            </div>
                            <h3 class="card-title">${chapter.title}</h3>
                            <p class="card-description">${chapter.description}</p>
                            <div class="card-footer">
                                <span class="section-count">${chapter.sections} sections</span>
                                <a href="chapters/${chapter.id}.html" class="btn btn-primary">${ctaText}</a>
                            </div>
                        `;
                        
                        grid.appendChild(card);
                    } catch (cardError) {
                        console.error('Error rendering chapter card:', chapter.id, cardError);
                        
                        // Create fallback card
                        const fallbackCard = document.createElement('div');
                        fallbackCard.className = 'chapter-card error-card';
                        fallbackCard.innerHTML = `
                            <h3>${chapter.title}</h3>
                            <p>Unable to load progress data</p>
                            <a href="chapters/${chapter.id}.html" class="btn btn-primary">Start</a>
                        `;
                        grid.appendChild(fallbackCard);
                    }
                });
                
                console.log(`Rendered ${chaptersData.length} chapter cards successfully`);
            } catch (error) {
                console.error('Critical error in renderChapterCards:', error);
                renderChapterCardsWithFallback();
            }
        }

        // Fallback rendering without progress calculation
        function renderChapterCardsWithFallback() {
            try {
                const grid = document.getElementById('chaptersGrid');
                if (!grid) return;
                
                grid.innerHTML = '';
                
                chaptersData.forEach(chapter => {
                    const card = document.createElement('div');
                    card.className = 'chapter-card';
                    card.setAttribute('data-category', chapter.category);
                    card.innerHTML = `
                        <div class="card-header">
                            <span class="chapter-number">${chapter.number}</span>
                        </div>
                        <h3 class="card-title">${chapter.title}</h3>
                        <p class="card-description">${chapter.description}</p>
                        <div class="card-footer">
                            <span class="section-count">${chapter.sections} sections</span>
                            <a href="chapters/${chapter.id}.html" class="btn btn-primary">Start</a>
                        </div>
                    `;
                    grid.appendChild(card);
                });
                
                console.log('Rendered chapter cards with fallback method');
            } catch (error) {
                console.error('Error in fallback rendering:', error);
            }
        }

        // Update overall progress with error handling
        function updateOverallProgress() {
            try {
                let totalSections = 0;
                let completedSections = 0;
                let completedChapters = 0;

                chaptersData.forEach(chapter => {
                    totalSections += chapter.sections;
                    
                    try {
                        let progress = 0;
                        
                        if (typeof window.calculateChapterProgress === 'function') {
                            progress = window.calculateChapterProgress(chapter.id) || 0;
                        } else if (typeof calculateChapterProgress === 'function') {
                            progress = calculateChapterProgress(chapter.id) || 0;
                        }
                        
                        progress = Math.max(0, Math.min(100, Number(progress) || 0));
                        completedSections += Math.round((progress / 100) * chapter.sections);
                        
                        if (progress === 100) {
                            completedChapters++;
                        }
                    } catch (chapterError) {
                        console.warn('Error calculating progress for chapter:', chapter.id, chapterError);
                    }
                });

                const overallPercentage = totalSections > 0 ? Math.round((completedSections / totalSections) * 100) : 0;
                
                // Update display elements safely
                const overallElement = document.getElementById('overallCompletion');
                const chaptersElement = document.getElementById('completedChapters');
                
                if (overallElement) {
                    overallElement.textContent = `${overallPercentage}%`;
                }
                if (chaptersElement) {
                    chaptersElement.textContent = completedChapters.toString();
                }
                
                console.log(`Overall progress: ${overallPercentage}%, Chapters completed: ${completedChapters}`);
            } catch (error) {
                console.error('Error updating overall progress:', error);
                
                // Set safe defaults
                const overallElement = document.getElementById('overallCompletion');
                const chaptersElement = document.getElementById('completedChapters');
                
                if (overallElement) overallElement.textContent = '0%';
                if (chaptersElement) chaptersElement.textContent = '0';
            }
        }

        // Setup filter buttons with error handling
        function setupFilterButtons() {
            try {
                const filterButtons = document.querySelectorAll('.filter-btn');
                const cards = document.querySelectorAll('.chapter-card');

                filterButtons.forEach(button => {
                    button.addEventListener('click', (event) => {
                        try {
                            // Update active button
                            filterButtons.forEach(btn => btn.classList.remove('active'));
                            button.classList.add('active');

                            // Filter cards
                            const filter = button.dataset.filter;
                            cards.forEach(card => {
                                if (filter === 'all' || card.dataset.category === filter) {
                                    card.style.display = 'block';
                                } else {
                                    card.style.display = 'none';
                                }
                            });
                        } catch (filterError) {
                            console.error('Error in filter button handler:', filterError);
                        }
                    });
                });
                
                console.log('Filter buttons set up successfully');
            } catch (error) {
                console.error('Error setting up filter buttons:', error);
            }
        }

        // Show error message to user
        function showErrorMessage(message) {
            try {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.innerHTML = `
                    <div style="background: #ffebee; border: 1px solid #f44336; padding: 12px; border-radius: 4px; margin: 16px 0; color: #c62828;">
                        <strong>Notice:</strong> ${message}
                    </div>
                `;
                
                const container = document.querySelector('.container');
                if (container && container.firstChild) {
                    container.insertBefore(errorDiv, container.firstChild);
                }
            } catch (error) {
                console.error('Error showing error message:', error);
            }
        }

        // Listen for progress updates
        window.addEventListener('progress-changed', () => {
            try {
                console.log('Progress changed, updating dashboard...');
                renderChapterCards();
                updateOverallProgress();
            } catch (error) {
                console.error('Error handling progress change:', error);
            }
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                // Page became visible, refresh progress
                setTimeout(() => {
                    try {
                        updateOverallProgress();
                        renderChapterCards();
                    } catch (error) {
                        console.error('Error refreshing on visibility change:', error);
                    }
                }, 100);
            }
        });

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeDashboard);
        } else {
            initializeDashboard();
        }

        console.log('Dashboard script loaded successfully');
    </script>
</body>
</html>
