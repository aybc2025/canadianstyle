<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter 2: Hyphenation - The Canadian Style</title>
    <link rel="stylesheet" href="../shared/css/main.css">
    <link rel="stylesheet" href="../shared/css/quiz-styles.css">
</head>
<body>
     <header class="site-header">
        <div class="container">
            <div class="logo-wrapper">
                <img src="../shared/img/maple-logo.svg" alt="Canadian Style Logo" class="logo">
                <h1>The Canadian Style</h1>
            </div>
            <nav class="chapter-nav">
                <a href="../index.html" class="btn btn-secondary">Back to Dashboard</a>
            </nav>
        </div>
    </header>

    <nav class="chapter-nav">
        <div class="container">
            <div class="chapter-header">
                <h2>Chapter 2: Hyphenation</h2>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="chapterProgress"></div>
                    </div>
                    <span class="progress-text">Progress</span>
                </div>
            </div>
            
            <div class="section-tabs" id="sectionNav">
                <a href="#introduction" class="tab-link active" data-section="introduction">2.01 Introduction</a>
                <a href="#compound-words" class="tab-link" data-section="compound-words">2.02 Compound Words</a>
                <a href="#prefixes-suffixes" class="tab-link" data-section="prefixes-suffixes">2.03 Prefixes & Suffixes</a>
                <a href="#word-division" class="tab-link" data-section="word-division">2.04 Word Division</a>
                <a href="#special-cases" class="tab-link" data-section="special-cases">2.05 Special Cases</a>
                <a href="#technical-terms" class="tab-link" data-section="technical-terms">2.06 Technical Terms</a>
            </div>
        </div>
    </nav>

    <main class="chapter-content">
        <div class="container">
            <!-- Section 2.01: Introduction -->
            <section class="content-section active" id="introduction">
                <div class="section-header">
                    <h2>2.01 Introduction</h2>
                </div>
                
                <div class="lesson-content">
                    <p>Hyphenation serves multiple purposes in Canadian English: joining compound words, preventing confusion, and maintaining readability. This chapter covers the essential rules for proper hyphenation in government documents.</p>
                    
                    <div class="key-point">
                        <strong>Key Principle:</strong> Use hyphens to clarify meaning and improve readability, but avoid overuse.
                    </div>
                </div>
                
                <div class="section-footer">
                    <button class="btn btn-primary" onclick="completeSection('introduction')">
                        Mark Complete & Continue
                    </button>
                </div>
            </section>

            <!-- Section 2.02: Compound Words -->
            <section class="content-section" id="compound-words">
                <div class="section-header">
                    <h2>2.02 Compound Words</h2>
                </div>
                
                <div class="lesson-content">
                    <p>Compound adjectives are hyphenated when they precede the noun they modify but not when they follow it.</p>
                    
                    <div class="rule-box">
                        <h3>Basic Rule</h3>
                        <ul>
                            <li><strong>Before the noun:</strong> "a well-known author"</li>
                            <li><strong>After the noun:</strong> "the author is well known"</li>
                        </ul>
                    </div>
                    
                    <div class="example-box">
                        <h3>Examples</h3>
                        <ul>
                            <li>✅ "state-of-the-art technology" vs "the technology is state of the art"</li>
                            <li>✅ "twenty-year-old building" vs "the building is twenty years old"</li>
                            <li>✅ "high-level meeting" vs "the meeting was high level"</li>
                        </ul>
                    </div>
                </div>
                
                <div class="quiz-panel" id="quiz-compound-words"></div>
                
                <div class="section-footer">
                    <button class="btn btn-primary" onclick="completeSection('compound-words')">
                        Mark Complete & Continue
                    </button>
                </div>
            </section>

            <!-- Section 2.03: Prefixes & Suffixes -->
            <section class="content-section" id="prefixes-suffixes">
                <div class="section-header">
                    <h2>2.03 Prefixes & Suffixes</h2>
                </div>
                
                <div class="lesson-content">
                    <p>Most prefixes are joined directly to the root word, but some require hyphens for clarity or convention.</p>
                    
                    <div class="rule-box">
                        <h3>Prefixes Requiring Hyphens</h3>
                        <ul>
                            <li><strong>self-:</strong> self-control, self-evident</li>
                            <li><strong>ex- (former):</strong> ex-president, ex-employee</li>
                            <li><strong>all-:</strong> all-Canadian, all-purpose</li>
                        </ul>
                    </div>
                    
                    <div class="rule-box">
                        <h3>Usually No Hyphen</h3>
                        <ul>
                            <li><strong>pre-, post-, non-, un-, re-:</strong> prewar, postgraduate, nonprofit, unusual, rewrite</li>
                        </ul>
                    </div>
                </div>
                
                <div class="quiz-panel" id="quiz-prefixes-suffixes"></div>
                
                <div class="section-footer">
                    <button class="btn btn-primary" onclick="completeSection('prefixes-suffixes')">
                        Mark Complete & Continue
                    </button>
                </div>
            </section>

            <!-- Section 2.04: Word Division -->
            <section class="content-section" id="word-division">
                <div class="section-header">
                    <h2>2.04 Word Division</h2>
                </div>
                
                <div class="lesson-content">
                    <p>When words must be divided at the end of a line, follow standard syllable divisions and maintain readability.</p>
                    
                    <div class="rule-box">
                        <h3>Division Rules</h3>
                        <ul>
                            <li>Divide between syllables: <strong>gov-ern-ment</strong></li>
                            <li>Never divide single-syllable words</li>
                            <li>Don't leave single letters on a line</li>
                            <li>Hyphenated words divide at the existing hyphen</li>
                        </ul>
                    </div>
                </div>
                
                <div class="quiz-panel" id="quiz-word-division"></div>
                
                <div class="section-footer">
                    <button class="btn btn-primary" onclick="completeSection('word-division')">
                        Mark Complete & Continue
                    </button>
                </div>
            </section>

            <!-- Section 2.05: Special Cases -->
            <section class="content-section" id="special-cases">
                <div class="section-header">
                    <h2>2.05 Special Cases</h2>
                </div>
                
                <div class="lesson-content">
                    <p>Certain situations require special attention to hyphenation rules, including numbers, fractions, and compound constructions.</p>
                    
                    <div class="rule-box">
                        <h3>Numbers</h3>
                        <ul>
                            <li>✅ twenty-one, thirty-five, ninety-nine</li>
                            <li>❌ twenty one, thirty five, ninety nine</li>
                        </ul>
                    </div>
                    
                    <div class="rule-box">
                        <h3>Fractions as Adjectives</h3>
                        <ul>
                            <li>✅ "a two-thirds majority"</li>
                            <li>✅ "one-half portion"</li>
                            <li>But: "two thirds of the committee" (as noun)</li>
                        </ul>
                    </div>
                </div>
                
                <div class="quiz-panel" id="quiz-special-cases"></div>
                
                <div class="section-footer">
                    <button class="btn btn-primary" onclick="completeSection('special-cases')">
                        Mark Complete & Continue
                    </button>
                </div>
            </section>

            <!-- Section 2.06: Technical Terms -->
            <section class="content-section" id="technical-terms">
                <div class="section-header">
                    <h2>2.06 Technical Terms</h2>
                </div>
                
                <div class="lesson-content">
                    <p>Technical and specialized terms follow standard hyphenation rules, with some field-specific conventions.</p>
                    
                    <div class="rule-box">
                        <h3>Common Technical Patterns</h3>
                        <ul>
                            <li><strong>IT:</strong> client-server, user-friendly, real-time</li>
                            <li><strong>Environmental:</strong> greenhouse-gas, climate-change</li>
                            <li><strong>Financial:</strong> cost-benefit, debt-to-income</li>
                        </ul>
                    </div>
                </div>
                
                <div class="quiz-panel" id="quiz-technical-terms"></div>
                
                <div class="section-footer">
                    <button class="btn btn-primary" onclick="completeSection('technical-terms')">
                        Chapter Complete!
                    </button>
                </div>
            </section>
        </div>
    </main>

    <footer class="site-footer">
        <div class="container">
            <p>&copy; 2024 Government of Canada. Based on <em>The Canadian Style</em> (1997 revised edition)</p>
        </div>
    </footer>

    <!-- Include JavaScript -->
    <script type="module">
        import { getProgress, setProgress } from '../shared/js/progress.js';
        import { QuizEngine } from '../shared/js/quiz-engine.js';
        import '../shared/js/components.js';
        
        const CHAPTER_ID = 'ch02';
        const sections = [
            { id: 'introduction', title: '2.01 Introduction' },
            { id: 'compound-words', title: '2.02 Compound Words' },
            { id: 'prefixes-suffixes', title: '2.03 Prefixes & Suffixes' },
            { id: 'word-division', title: '2.04 Word Division' },
            { id: 'special-cases', title: '2.05 Special Cases' },
            { id: 'technical-terms', title: '2.06 Technical Terms' }
        ];

        // Section mapping for ch02
        const SECTION_MAPPING = {
            'compound-words': 'compound-adjectives',
            'word-division': 'numbers-fractions',
            'special-cases': 'compound-adjectives'
        };

        // ✅ הוספת פונקציית showSection החסרה
        function showSection(sectionId) {
            // הסתרת כל החלקים
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
            });
            
            // הצגת החלק הנוכחי
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
                targetSection.style.display = 'block';
            }
        }

        // ✅ הוספת פונקציית updateActiveTab החסרה
        function updateActiveTab(activeLink) {
            document.querySelectorAll('.tab-link').forEach(link => {
                link.classList.remove('active');
            });
            if (activeLink) {
                activeLink.classList.add('active');
            }
        }

        // ✅ הוספת פונקציית initSectionNavigation החסרה
        function initSectionNavigation() {
            const tabLinks = document.querySelectorAll('.tab-link');
            
            tabLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const sectionId = this.getAttribute('data-section');
                    showSection(sectionId);
                    updateActiveTab(this);
                });
            });
            
            // הצגת החלק הראשון כברירת מחדל
            showSection('introduction');
        }
        
        // ✅ הוספת פונקציית updateProgressBar החסרה
        function updateProgressBar() {
            const progress = getProgress(CHAPTER_ID);
            const chapterProgress = progress || {};
            const completed = Object.values(chapterProgress).filter(Boolean).length;
            const percentage = Math.round((completed / sections.length) * 100);
            
            const progressBar = document.getElementById('chapterProgress');
            if (progressBar) {
                progressBar.style.width = percentage + '%';
            }
        }
        
        // ✅ תיקון פונקציית completeSection
        window.completeSection = function(sectionId) {
            setProgress(CHAPTER_ID, sectionId, true);
            updateProgressBar();
            
            // Navigate to next section
            const currentIndex = sections.findIndex(s => s.id === sectionId);
            if (currentIndex !== -1 && currentIndex < sections.length - 1) {
                const nextSection = sections[currentIndex + 1];
                showSection(nextSection.id);
                updateActiveTab(document.querySelector(`[data-section="${nextSection.id}"]`));
            } else {
                // Chapter complete
                showCompletionModal();
            }
        };
        
        // ✅ הוספת פונקציית showCompletionModal החסרה
        function showCompletionModal() {
            const modal = document.createElement('div');
            modal.className = 'completion-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>🎉 Chapter 2 Complete!</h3>
                    <p>You've mastered hyphenation! Your writing will now be more consistent and clear.</p>
                    <div class="modal-buttons">
                        <button onclick="window.location.href='../index.html'" class="btn btn-primary">
                            Back to Dashboard
                        </button>
                        <button onclick="window.location.href='ch03.html'" class="btn btn-secondary">
                            Next Chapter: Spelling
                        </button>
                    </div>
                </div>
            `;
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            document.body.appendChild(modal);
        }
        
        // Enhanced quiz loading with mapping
        async function loadSectionQuizzes() {
            try {
                console.log(`🔍 Loading quizzes for ${CHAPTER_ID}...`);
                
                const response = await fetch(`../data/${CHAPTER_ID}-quiz.json`);
                if (!response.ok) {
                    console.warn(`📄 Quiz data not available for ${CHAPTER_ID} (${response.status})`);
                    return;
                }
                
                const quizData = await response.json();
                const availableQuizSections = Object.keys(quizData.sections || {});
                console.log(`📚 Available quiz sections: [${availableQuizSections.join(', ')}]`);
                
                let successCount = 0;
                
                // Initialize quizzes for sections that have them
                sections.forEach(section => {
                    const htmlSectionId = section.id;
                    
                    // Try different strategies to find matching quiz
                    let quizSectionId = null;
                    let matchType = '';
                    
                    // Strategy 1: Direct match
                    if (quizData.sections?.[htmlSectionId]) {
                        quizSectionId = htmlSectionId;
                        matchType = 'direct';
                    }
                    // Strategy 2: Use mapping
                    else if (SECTION_MAPPING[htmlSectionId] && quizData.sections?.[SECTION_MAPPING[htmlSectionId]]) {
                        quizSectionId = SECTION_MAPPING[htmlSectionId];
                        matchType = 'mapped';
                    }
                    // Strategy 3: Fuzzy match by keywords
                    else {
                        const htmlWords = htmlSectionId.split('-');
                        const fuzzyMatch = availableQuizSections.find(quizId => {
                            const quizWords = quizId.split('-');
                            return htmlWords.some(word => 
                                quizWords.includes(word) || 
                                quizId.includes(word) ||
                                (word.length > 3 && quizId.includes(word.substring(0, 4)))
                            );
                        });
                        
                        if (fuzzyMatch) {
                            quizSectionId = fuzzyMatch;
                            matchType = 'fuzzy';
                        }
                    }
                    
                    // Create quiz if we found a match
                    if (quizSectionId && quizData.sections[quizSectionId]) {
                        const sectionQuizData = quizData.sections[quizSectionId];
                        
                        if (sectionQuizData.questions && sectionQuizData.questions.length > 0) {
                            const quizContainer = document.getElementById(`quiz-${htmlSectionId}`);
                            
                            if (quizContainer) {
                                console.log(`✅ Creating quiz for "${htmlSectionId}" using "${quizSectionId}" (${matchType}) - ${sectionQuizData.questions.length} questions`);
                                
                                const quizEngine = new QuizEngine(sectionQuizData, CHAPTER_ID, htmlSectionId);
                                quizEngine.render(quizContainer);
                                successCount++;
                            } else {
                                console.warn(`📦 Quiz container not found: quiz-${htmlSectionId}`);
                            }
                        } else {
                            console.warn(`❓ No questions found in section ${quizSectionId}`);
                        }
                    } else {
                        console.log(`❌ No quiz match found for "${htmlSectionId}"`);
                        
                        // Show available options for debugging
                        if (availableQuizSections.length > 0) {
                            console.log(`💡 Available: [${availableQuizSections.join(', ')}]`);
                        }
                    }
                });
                
                console.log(`🎯 Successfully loaded ${successCount}/${sections.length} quizzes for ${CHAPTER_ID}`);
                
            } catch (error) {
                console.error(`💥 Error loading quiz data for ${CHAPTER_ID}:`, error);
            }
        }
        
        // ✅ הרצת כל הפונקציות לאחר טעינת הדף
        document.addEventListener('DOMContentLoaded', function() {
            console.log(`🚀 Initializing ${CHAPTER_ID}...`);
            
            initSectionNavigation();
            updateProgressBar();
            loadSectionQuizzes();
            
            console.log(`✅ ${CHAPTER_ID} initialized successfully`);
        });

        // Handle window beforeunload for quiz warnings
        window.addEventListener('beforeunload', (event) => {
            const activeQuiz = document.querySelector('.quiz-engine-container .quiz-in-progress');
            if (activeQuiz) {
                event.preventDefault();
                event.returnValue = 'You have a quiz in progress. Are you sure you want to leave?';
            }
        });
    </script>
</body>
</html>
